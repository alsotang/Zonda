define(function(e,t,n){var r=e("underscore"),i=e("jquery"),s=e("backbone");r.extend(t,s.Events),t.loading=function(e){t.on("loading",function(t){e(t)})},t.ready=function(e){t.on("ready",function(t){e(t)})},t.config={};var o={url:"",fileType:"",DOMWrap:"",msg:"",tpl:""};i.browser.msie&&(o.ieUploadForm="");var u={},a=function(){if(r.isEqual(u,t.config))return!1;u=t.config;try{r.each(o,function(e,n){if(!r.has(t.config,n))throw new Error("上传文件模块未配置"+n)})}catch(e){window.console!==undefined?console.error(e.message):alert(e.message)}r.isString(t.config.fileType)&&(t.config.fileType=t.config.fileType.replace(/\s{1,}/g,""),t.config.fileType=t.config.fileType.split(","))},f=function(e){var n=[],s=[];if(e.length!==undefined&&e.length===0)n.push("暂不支持直接上传文件夹，请压缩后上传<br />");else if(i.browser.msie){var o=i(t.config.ieUploadForm).find("input:file").val().split("."),u=r.last(o).toLowerCase();return r.include(t.config.fileType,u)?1:(n.push('<span class="black">[ '+o+" ]</span> 为不允许上传的文件类型<br />"),t.config.msg(n.toString(),"error"),0)}return r.each(e,function(e,i){var o=e.name.split("."),u=r.last(o).toLowerCase();o.length===1?n.push('<span class="black">[ '+e.name+" ]</span> 无后缀名，请重新选择<br />"):r.include(t.config.fileType,u)?s.push(e):n.push('<span class="black">[ '+e.name+" ]</span> 为不允许上传的文件类型<br />")}),t.config.msg(n.toString(),"error"),s},l=function(e){var t=e.split("."),n=r.last(t).toLowerCase(),i=["jpeg","jpg","png","gif","bmp"],s=["doc","docx","ppt","pptx","xls","xlsx"];return r.include(i,n)?"1":r.include(s,n)?"2":"3"},c=function(e,n,s){this.fileName=e,this.fileType=n,this.fileSize=s;var o=r.template(t.config.tpl,this);i(t.config.DOMWrap).find("ul").prepend(o),this.dom=i(t.config.DOMWrap).find("li").eq(0);var u=this;return i(this.dom).find(".delete").click(function(){u.dom.remove()}),this},h=null,p,d=function(){p=i(t.config.ieUploadForm).find("input:file").val();if(!f(p))return!1;t.trigger("loading","Sending..."),h===null&&(h=i('iframe[name="'+t.config.ieUploadForm.target+'"]')),h.attr("isBind")!=="yes"&&(h.attr("isBind","yes"),h.on("load",function(){var e=new c(p);try{var n=window.frames[t.config.ieUploadForm.target].data;n.status===1?(e.dom.find("a").attr("href",n.data.url),t.trigger("ready","Ready")):(t.config.msg("发生错误: "+e.fileName+n.info,"error"),e.dom.remove(),t.trigger("ready","Error"))}catch(r){t.config.msg("发生错误: "+e.fileName+r,"error"),e.dom.remove(),t.trigger("ready","Error")}})),i(t.config.ieUploadForm).submit()};t.upload=function(e){a();if(i.browser.msie)return d(),!1;var n=f(e);r.each(n,function(e,n){var r=new c(e.name,e.type,e.size),s=new XMLHttpRequest,o=new FormData;o.append("file",e),o.append("upload_type",l(e.name)),o.append("ajax",1),s.open("POST",t.config.url,!0),t.trigger("loading","Sending");if(i(r.dom).find("progress")[0]){var u=i(r.dom).find("progress")[0];u.min=0,u.max=100,u.value=0,s.onload=function(){i(u).hide()},s.upload.onprogress=function(e){e.lengthComputable&&(u.value=u.innerHTML=e.loaded/e.total*100||0)}}s.onreadystatechange=function(){if(s.readyState===4)try{var e=i.parseJSON(s.response);e.status===1?(r.dom.find("a").attr("href",e.data.url),t.trigger("ready","完成")):(t.config.msg("发生错误: "+r.fileName+e.info,"error"),r.dom.remove(),t.trigger("ready","Error"))}catch(n){t.config.msg("发生错误: "+n,"error"),t.trigger("ready","Error")}},s.send(o)})},t.needConfig=function(){return o}});